# Система управления роем дронов

## Описание
Система управления роем дронов представляет собой программный комплекс для автоматизированного управления группой беспилотных летательных аппаратов. Система обеспечивает одновременный запуск до 10 дронов, автоматическое определение и распределение целей между дронами, предотвращение столкновений и координацию действий всего роя.

## Основные возможности
- Одновременное управление роем из 10 дронов
- Автоматическое распределение дронов по территории в режиме патрулирования
- Обнаружение и классификация целей с использованием компьютерного зрения
- Автоматическое распределение целей между дронами с учетом приоритетов
- Интеллектуальная система предотвращения столкновений
- Отслеживание пройденного расстояния и заряда батареи
- Визуализация полета и статуса дронов в реальном времени
- Ручное и автоматическое переключение между режимами патрулирования и атаки
- Экстренная остановка всех дронов

## Архитектура системы
Система состоит из следующих основных компонентов:

1. **SwarmController** - центральный контроллер управления роем
2. **Drone** - класс для управления отдельным дроном
3. **TargetDetector** - система обнаружения и отслеживания целей
4. **DroneSwarmSystem** - главный класс приложения
5. **DroneAdapter** - адаптер для работы с реальными дронами
6. **DroneConnector** - коннекторы для разных типов дронов (DJI, MAVLink, Parrot)

## Требования
- Python 3.8+
- OpenCV
- NumPy
- YOLOv8 (через библиотеку Ultralytics)
- PyTorch
- DroneKit (для MAVLink дронов)
- djitellopy (для DJI Tello)
- Olympe (для Parrot, только Linux)
- Сетевое соединение (для контроля реальных дронов)

## Установка и запуск

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Дополнительные установки для разных типов дронов

#### DJI Tello
```bash
pip install djitellopy
```

#### ArduPilot/PX4 (MAVLink)
```bash
pip install dronekit pymavlink
```

#### Parrot (только Linux)
Olympe доступен только для Linux. Установку Olympe необходимо производить согласно [официальной документации Parrot](https://developer.parrot.com/docs/olympe/).

### 3. Запуск системы в режиме симуляции
```bash
python main.py --num-drones 10
```

### 4. Запуск с реальными дронами
```bash
python main.py --num-drones 3 --real-drones
```

## Интерфейс оператора
После запуска откроются два окна:
- **Drone Swarm Control** - карта с отображением положения дронов и целей
- **Drone Camera View** - вид с камеры выбранного дрона

Доступные команды в консоли оператора:
- `attack` - Включить режим атаки
- `patrol` - Включить режим патрулирования
- `status` - Показать текущий статус роя
- `select <id>` - Выбрать дрон для просмотра с камеры
- `stop` - Экстренная остановка всех дронов
- `quit` - Выход из программы

## Режимы работы

### Режим патрулирования
В этом режиме дроны равномерно распределяются по территории и следуют по заданным маршрутам патрулирования. Каждый дрон получает свой уникальный сектор для патрулирования.

### Режим атаки
В режиме атаки дроны обнаруживают цели и автоматически распределяют их между собой с учетом приоритетов целей, расстояния и эффективности атаки. Один дрон атакует только одну цель, исключая конфликты между дронами.

## Интеграция с реальными дронами

Система поддерживает подключение к реальным дронам через соответствующие коннекторы.

### Поддерживаемые платформы и примеры подключения

#### 1. DJI Tello

```python
from drone_adapater import DroneAdapter

# Создание и подключение к дрону DJI Tello
drone = DroneAdapter(
    drone_id=0,
    drone_type='dji',
    connection_params={
        'ip': '192.168.10.1',  # IP-адрес дрона Tello
    }
)

# Подключение к дрону
drone.connect()

# Взлет на высоту 1.5 метра
drone.takeoff(1.5)

# Начало патрулирования (случайные точки вокруг текущей позиции)
drone.start_patrol()

# Посадка дрона
drone.land()

# Отключение
drone.disconnect()
```

#### 2. ArduPilot/PX4 (MAVLink)

```python
from drone_adapater import DroneAdapter

# Создание и подключение к дрону с ArduPilot
drone = DroneAdapter(
    drone_id=1,
    drone_type='mavlink',
    connection_params={
        'connection_string': 'udp:127.0.0.1:14550',  # Для SITL-симулятора
        # 'connection_string': '/dev/ttyACM0',  # Для подключения по USB
        # 'connection_string': 'tcp:192.168.1.10:5760',  # Для подключения по сети
        'baud': 57600  # Скорость соединения для последовательного порта
    }
)

# Подключение к дрону
drone.connect()

# Взлет на 30 метров
drone.takeoff(30)

# Движение к точке
drone.move_to(np.array([100, 100, 30]))  # Координаты в метрах

# Возврат на базу
drone.return_to_base()

# Отключение
drone.disconnect()
```

#### 3. Parrot (Anafi, Bebop)

```python
from drone_adapater import DroneAdapter

# Создание и подключение к дрону Parrot Anafi
drone = DroneAdapter(
    drone_id=2,
    drone_type='parrot',
    connection_params={
        'ip': '192.168.42.1',  # IP-адрес дрона Anafi
        'model': 'anafi'  # Модель дрона
    }
)

# Подключение к дрону
drone.connect()

# Взлет на 10 метров
drone.takeoff(10)

# Установка скорости
drone.set_velocity(np.array([2.0, 0.0, 0.0]))  # 2 м/с вперед

# Экстренная остановка
drone.emergency_stop()

# Отключение
drone.disconnect()
```

### Настройка соединения для разных типов дронов

#### DJI дроны
1. **Tello**: 
   - Подключитесь к WiFi сети дрона (обычно название начинается с TELLO)
   - IP по умолчанию: 192.168.10.1, порт: 8889

2. **Другие DJI дроны (через Mobile SDK)**:
   - Требуется отдельная установка DJI Mobile SDK
   - Подключение через USB OTG кабель или WiFi

#### MAVLink дроны (ArduPilot/PX4)
1. **Подключение через USB**:
   - Подключите полетный контроллер к компьютеру по USB
   - Строка подключения: `/dev/ttyUSB0` или `/dev/ttyACM0` (Linux), `COM3` (Windows)
   - Скорость соединения: обычно 57600 или 115200 бод

2. **Подключение по WiFi/3G/LTE**:
   - Строка подключения: `udp:192.168.1.10:14550` или `tcp:192.168.1.10:5760`
   - Требуется настройка телеметрии на дроне

3. **Симулятор SITL**:
   - Строка подключения: `udp:127.0.0.1:14550`
   - Полезно для тестирования без реального дрона

#### Parrot дроны
1. **Подключение к Anafi/Bebop**:
   - Подключитесь к WiFi сети дрона
   - IP по умолчанию: 192.168.42.1
   - Olympe SDK работает только на Linux

### Калибровка и настройка дронов

Перед использованием реальных дронов необходимо выполнить ряд подготовительных действий:

1. **Калибровка компаса**: 
   ```python
   # Для MAVLink дронов
   vehicle.commands.download()
   vehicle.commands.wait_ready()
   vehicle.commands.clear()
   
   # Запуск калибровки
   vehicle._master.mav.command_long_send(
       vehicle._master.target_system, vehicle._master.target_component,
       mavutil.mavlink.MAV_CMD_PREFLIGHT_CALIBRATION,
       0, 0, 0, 0, 0, 1, 0, 0)
   ```

2. **Установка домашней позиции**:
   ```python
   # Для MAVLink дронов
   vehicle.home_location = vehicle.location.global_frame
   ```

3. **Проверка уровня заряда и GPS-сигнала**:
   ```python
   # Проверка статуса дрона
   print(f"Заряд батареи: {drone.get_battery_level()}%")
   
   # Для MAVLink дронов
   print(f"GPS статус: {vehicle.gps_0}")
   ```

## Протокол взаимодействия с дронами
Система использует следующий протокол команд:
- **Запуск**: инициализация дрона, проверка систем, взлет
- **Патрулирование**: передача массива точек маршрута
- **Слежение за целью**: передача координат цели
- **Атака**: команда на выполнение атаки по координатам цели
- **Возврат на базу**: команда на возврат дрона в исходную точку
- **Экстренная остановка**: немедленная остановка всех активных действий

## Пример создания роя из реальных дронов

```python
from drone_adapter import DroneAdapter
import numpy as np
import time

# Создание роя из 3 дронов разных типов
drone1 = DroneAdapter(0, 'dji', {'ip': '192.168.10.1'})
drone2 = DroneAdapter(1, 'mavlink', {'connection_string': 'udp:127.0.0.1:14550'})
drone3 = DroneAdapter(2, 'mavlink', {'connection_string': 'udp:127.0.0.1:14551'})

# Список дронов
drones = [drone1, drone2, drone3]

# Подключение всех дронов
for drone in drones:
    drone.connect()
    print(f"Подключен дрон {drone.id}, тип: {'симулированный' if drone.is_simulated else 'реальный'}")

# Взлет всех дронов
for drone in drones:
    drone.takeoff(30)  # Взлет на 30 метров
    time.sleep(5)  # Ожидание завершения взлета

# Распределение точек патрулирования
patrol_points = [
    [np.array([100, 0, 30]), np.array([200, 100, 40]), np.array([100, 200, 30])],
    [np.array([-100, 0, 35]), np.array([-200, -100, 45]), np.array([-100, -200, 35])],
    [np.array([0, 100, 25]), np.array([100, 200, 35]), np.array([200, 100, 25])]
]

# Отправка дронов на патрулирование
for i, drone in enumerate(drones):
    drone.start_patrol(patrol_points[i])

# Мониторинг состояния дронов
try:
    while True:
        for drone in drones:
            status = drone.get_status()
            print(f"Дрон {status['id']}: состояние={status['state']}, "
                  f"заряд={status['battery']:.1f}%, "
                  f"пройдено={status['distance_traveled']/1000:.2f} км")
        time.sleep(5)
except KeyboardInterrupt:
    print("Прерывание по команде оператора")
    
# Возврат всех дронов на базу
for drone in drones:
    drone.return_to_base()
    
# Ожидание возврата и отключение
time.sleep(30)
for drone in drones:
    drone.disconnect()
```

## Логирование
Система ведет подробный журнал всех операций в директории `logs`. Каждая сессия создает отдельный файл лога с временной меткой.

## Безопасность
Система включает несколько уровней безопасности:
- Автоматическое предотвращение столкновений между дронами
- Контроль заряда батареи с автоматическим возвратом при критическом уровне
- Ограничение области полета
- Возможность экстренной остановки всех дронов

## Ограничения и рекомендации
- Рекомендуемое максимальное количество дронов: 10
- Оптимальная высота полета: 50-100 метров
- Рекомендуемое расстояние между дронами: не менее 30 метров
- Система рассчитана на работу на открытых пространствах
- При интеграции с физическими дронами рекомендуется первые испытания проводить на малых высотах

## Дополнительная информация
Система разработана с учетом возможности дальнейшего масштабирования и добавления новых функций, таких как:
- 3D-картографирование местности
- Автоматическое следование за движущимися целями
- Расширенная аналитика собранных данных
- Интеграция с внешними системами управления 